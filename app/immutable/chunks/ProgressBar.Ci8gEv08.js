var A=Object.defineProperty;var _=s=>{throw TypeError(s)};var w=(s,e,t)=>e in s?A(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>w(s,typeof e!="symbol"?e+"":e,t),F=(s,e,t)=>e.has(s)||_("Cannot "+t);var o=(s,e,t)=>(F(s,e,"read from private field"),t?t.call(s):e.get(s)),u=(s,e,t)=>e.has(s)?_("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t);import{s as n,h as l,f as h,L as N,M as k}from"./runtime.B12n482M.js";import{p as c}from"./proxy.zSiyNrLj.js";import{c as E,d as m,o as v,e as P,f as T,g as R,u as i,a as x}from"./userState.svelte.BiOIUSaf.js";import{o as L}from"./index-client.iHok3rNk.js";import{o as O,c as W,t as q,q as B}from"./disclose-version.Np_JnyxY.js";const I=function(){if(!r.user)return console.warn("No user to fetch to page doc for."),()=>{};const s=E(m,"users",r.user.uid,"pages");return v(s,e=>{e.docChanges().forEach(t=>{const C=t.doc.data(),U=t.doc.id;(t.type==="added"||t.type==="modified")&&(r.pageDocs[U]=C),t.type==="removed"&&delete r.pageDocs[U]})})},K=function(){if(!r.user)return console.warn("No user to fetch to user doc for."),()=>{};const s=P(m,"users",r.user.uid);return v(s,e=>{if(!e.exists())console.log("Creating firestore user doc..."),T(s,{},{merge:!0});else{console.log("Fetched firestore userDoc. fromCache:",e.metadata.fromCache,"hasPendingWrites:",e.metadata.hasPendingWrites);const t=e.data();r.userDoc=t,r.triggerUserDocUpdate()}},e=>{console.error("Error while fetching firestore user doc",e)})};async function S(){const s=r.user;if(!s){console.warn("No user to publish to firestore.");return}r.isPublishing=!0;const e=P(m,"users",s.uid);try{console.log("Publishing user State to firestore user doc..."),await R(e,{lastUpdated:i.lastUpdated,themeName:i.themeName,spellcheck:i.spellcheck})}catch(t){console.error("Error while publishing settings to firestore user doc",t)}finally{r.isPublishing=!1}}const M=function(){const s=i.subscribe(()=>{i.lastUpdated>r.userDoc.lastUpdated&&S()}),e=r.subscribeToUserDoc(()=>{if(r.userDoc.lastUpdated===i.lastUpdated){console.log("firebaseState and userState are synced.");return}else r.userDoc.lastUpdated>i.lastUpdated?(console.log("userState updated."),r.userDoc.themeName!==void 0&&(i.themeName=r.userDoc.themeName),r.userDoc.spellcheck!==void 0&&(i.spellcheck=r.userDoc.spellcheck)):S()});return()=>{s(),e()}};var b,d,g,f,p;class Y{constructor(){u(this,b,n(null));a(this,"_unsubscribeAuth");a(this,"_unsubscribeUserDoc",()=>{});a(this,"_unsubscribeUserDocSync",()=>{});a(this,"_unsubscribePagesCollection",()=>{});a(this,"_userDocObservers",[]);u(this,d,n(c({})));u(this,g,n(c({})));u(this,f,n(!1));u(this,p,n(!0));this._unsubscribeAuth=x.onAuthStateChanged(e=>{this._user=e,this.isLoading=!1,this.onAuthChange()})}get _user(){return l(o(this,b))}set _user(e){h(o(this,b),c(e))}get userDoc(){return l(o(this,d))}set userDoc(e){h(o(this,d),c(e))}get pageDocs(){return l(o(this,g))}set pageDocs(e){h(o(this,g),c(e))}get isPublishing(){return l(o(this,f))}set isPublishing(e){h(o(this,f),c(e))}get isLoading(){return l(o(this,p))}set isLoading(e){h(o(this,p),c(e))}get user(){return this._user}onAuthChange(){this.user?(console.warn("Subscribing to user."),this._unsubscribeUserDoc=K(),this._unsubscribePagesCollection=I(),this._unsubscribeUserDocSync=M()):(console.warn("Unsubscribing from user."),this._unsubscribeUserDoc(),this._unsubscribePagesCollection(),this._unsubscribeUserDocSync())}subscribeToUserDoc(e){return this._userDocObservers.push(e),()=>this.unsubscribeFromUserDoc(e)}unsubscribeFromUserDoc(e){this._userDocObservers=this._userDocObservers.filter(t=>t!==e)}triggerUserDocUpdate(){this._userDocObservers.forEach(e=>e())}destroy(){console.warn("Unsubscribing from user, userDoc, and pagesCollection."),this._unsubscribeAuth(),this._unsubscribeUserDoc(),this._unsubscribePagesCollection(),this._unsubscribeUserDocSync()}}b=new WeakMap,d=new WeakMap,g=new WeakMap,f=new WeakMap,p=new WeakMap;const r=new Y;var D;class j{constructor(){u(this,D,n(""));L(()=>{})}get authRedirect(){return l(o(this,D))}set authRedirect(e){h(o(this,D),c(e))}}D=new WeakMap;const y=Symbol("APPSTATE");function Z(){return N(y,new j)}function $(){return k(y)}var z=q('<div class="progress-bar svelte-1u2nbnk"><div class="progress-bar-value svelte-1u2nbnk"></div></div>');function ee(s){var e=z();O(e),B(e),W(s,e)}export{ee as P,r as f,$ as g,Z as s};
