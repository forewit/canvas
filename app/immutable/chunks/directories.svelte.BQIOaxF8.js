import{p as a}from"./proxy.CDy8FXUy.js";import{s as h,g as m,e as D,f as r,i as u,j as F,k as x,u as C,l as O}from"./runtime.fZwd0kuQ.js";import{g as T}from"./app.svelte.DRcnNZ_c.js";function z(){let s=D(0),n=D(a({})),d=a([]),g=x(()=>c(d));const l=T();l.subscribeToDirectoriesCollection(p);function p(t,o){if(t!=="root"){console.warn("Only root directory is currently supported");return}let e=l.directoriesCollection.root;if(o==="removed"||!e){console.warn("Root directory does not exist! publishing new root"),l.publishDataToDirectoryDoc("root",{lastUpdated:r(s),root:r(n)});return}let{wasValid:f,sanitizedDirectory:i}=w(e);if(!f){console.warn("Sanitized invalid root directory",l.directoriesCollection.root,i),l.publishDataToDirectoryDoc("root",i);return}i.lastUpdated<r(s)?l.publishDataToDirectoryDoc("root",{lastUpdated:r(s),root:r(n)}):i.lastUpdated>r(s)?(u(n,a(i.root)),u(s,a(i.lastUpdated))):i.lastUpdated===r(s)&&console.log("root directory synced with firebase")}function w(t){let o=!0,e={lastUpdated:Date.now(),root:{}};return Object.hasOwn(t,"lastUpdated")&&typeof t.lastUpdated=="number"?e.lastUpdated=t.lastUpdated:o=!1,Object.hasOwn(t,"root")&&typeof t.root=="object"?e.root=t.root:o=!1,{wasValid:o,sanitizedDirectory:e}}function c(t){let o=r(n);for(let e=0;e<t.length;(e+=1)-1){if(!o.folders)throw new Error("Folder does not exist");if(o=o.folders[t[e]],!o)throw new Error("Folder does not exist")}return o}function b(t,o){let e=t,f=c(o);if(!f.folders)return e;let i=1;for(;f.folders[e];)e=`${t} (${i})`,i+=1;return e}function U(t="New Folder"){const o=b(t,d);let e=c(d);e.folders||(e.folders={}),e.folders[o]={}}return F(()=>{C(()=>{r(n),console.log("ROOT UPDATED",JSON.stringify(r(n))),O(()=>{r(s)!==0&&(u(s,a(Date.now())),p("root","modified"))})})}),{get root(){return r(n)},get currentPath(){return d},get currentFolder(){return r(g)},get newFolder(){return U},get getFolder(){return c}}}const y=Symbol("directories"),S=()=>{const s=z();return h(y,s)},_=()=>m(y);export{_ as g,S as s};
