import{p as l}from"./proxy.DiDwt1nQ.js";import{s as I,g as O,e as c,f as e,i as d,u as S,j as z,k as R}from"./runtime.D_LhCXyF.js";import{g as j}from"./app.svelte.DnnDf6HZ.js";function E(){let n=c(0),u=c(l({title:"root"})),f=c(l([])),o=z(()=>D(e(f))),g=c(!0);const p=j();function D(t){var s;let r=e(u);for(let i=0;i<t.length;(i+=1)-1)if(r=(s=r.subfolders)==null?void 0:s.find(a=>a.title===t[i]),r===void 0)throw new Error("Folder does not exist");return r}function m(t){let r={lastUpdated:Date.now(),root:{title:"root"}};const s=Object.hasOwn(t,"lastUpdated")&&typeof t.lastUpdated=="number"&&Object.hasOwn(t,"root")&&typeof t.root=="object";return s&&(r.lastUpdated=t.lastUpdated,r.root=t.root),{wasValid:s,sanitizedDirectory:r}}function w(t,r){let s=t,i=D(r);if(!i.subfolders)return s;let a=1;for(;i.subfolders.some(F=>F.title===s);)s=`${t} (${a})`,a+=1;return s}function b(){p.publishDoc(["directories","root"],{lastUpdated:e(n),root:e(u)})}function h(t="New Folder"){const r=w(t,e(f));e(o).subfolders||(e(o).subfolders=[]),e(o).subfolders.push({title:r})}function U(t){e(o).subfolders&&(e(o).subfolders=e(o).subfolders.filter(r=>r.title!==t),e(o).subfolders.length===0&&delete e(o).subfolders)}function x(t){e(o).ids||(e(o).ids=[]),e(o).ids.push(t)}function v(t){e(o).ids&&(e(o).ids=e(o).ids.filter(r=>r!==t),e(o).ids.length===0&&delete e(o).ids)}function C(t){d(f,l(t))}return p.subscribeToCollection(["directories"],(t,r)=>{if(t!=="root"){console.warn("Only root directory is currently supported");return}if(r===null){console.warn("Root directory does not exist! publishing new root"),b();return}let{wasValid:s,sanitizedDirectory:i}=m(r);if(!s){console.warn("Ignoring invalid root directory",r);return}i.lastUpdated<e(n)?b():i.lastUpdated>e(n)?(console.log("root directory updated"),d(g,!0),d(n,l(i.lastUpdated)),d(u,l(i.root))):i.lastUpdated===e(n)&&console.log("directory synced with firebase",t)}),S(()=>{JSON.stringify(e(u)),R(()=>{if(e(g)){d(g,!1);return}d(n,l(Date.now())),b()})}),{get root(){return e(u)},get currentPath(){return e(f)},get goto(){return C},get currentFolder(){return e(o)},get addSubfolder(){return h},get removeSubfolder(){return U},get addPageID(){return x},get removeDocID(){return v}}}const y=Symbol("directories"),k=()=>{const n=E();return I(y,n)},V=()=>O(y);export{V as g,k as s};
