import{p as d}from"./if.D3RmbbZj.js";import{x as m,y as O,z as b,w as e,A as p,B as I,C as P,u as R}from"./runtime.4vCN5gQe.js";import{a as x}from"./app.svelte.C_YXpmtr.js";function E(){let a=d({});const g=x();g.subscribeToCollection(["pages"],w);function w(r,s){let l=a[r];if(!s){l&&delete a[r],console.log("deleted page",r.slice(0,4));return}let{wasValid:y,sanitizedPage:u}=o(s);if(!y){console.warn("Ignoring invalid page",s);return}if(!l){a[r]=h(r,u),console.log("added page",r);return}u.lastUpdated<l.lastUpdated?g.publishDoc(["pages",r],l):u.lastUpdated>l.lastUpdated?a[r]=h(r,u):u.lastUpdated===l.lastUpdated&&console.log("page synced with firebase",r)}function o(r){let s={title:"New Page",content:"",lastUpdated:Date.now()};const l=Object.hasOwn(r,"lastUpdated")&&typeof r.lastUpdated=="number"&&Object.hasOwn(r,"title")&&typeof r.title=="string"&&Object.hasOwn(r,"content")&&typeof r.content=="string";return l&&(s.lastUpdated=r.lastUpdated,s.title=r.title,s.content=r.content),{wasValid:l,sanitizedPage:s}}const h=function(r,s){let l=b(d(s.lastUpdated)),y=b(d(s.title)),u=b(d(s.content));return{get lastUpdated(){return e(l)},set lastUpdated(f){p(l,d(f))},get title(){return e(y)},set title(f){f!==e(y)&&(p(y,d(f)),p(l,d(Date.now())),g.publishDoc(["pages",r],a[r]))},get content(){return e(u)},set content(f){f!==e(u)&&(p(u,d(f)),p(l,d(Date.now())),g.publishDoc(["pages",r],a[r]))}}};return new Proxy(a,{set:(r,s,l)=>(r[s]=h(s,l),g.publishDoc(["pages",s],l),!0),deleteProperty:(r,s)=>(delete r[s],g.publishDoc(["pages",s],null),!0)})}const C=Symbol("pages"),v=()=>{const a=E();return m(C,a)},N=()=>O(C);function V(){let a=b(0),g=b(!0),w=d({name:"Home",type:"folder",children:[]}),o=b(d({root:w})),h=b(d(["root"])),D=P(()=>e(o)[e(h)[e(h).length-1]]),r=P(()=>{let t=Object.keys(e(o)).filter(i=>i!=="root"),n=["root"];for(;n.length>0;){let i=n.pop();if(!i||e(o)[i].type!=="folder")continue;let c=e(o)[i];for(let U of c.children)t=t.filter(k=>k!==U),n.push(U)}return t});const s=N();let l=P(()=>{let t=Object.keys(s),n=["root"];for(;n.length>0;){let i=n.pop();if(!i)continue;let c=e(o)[i];if(c.type==="folder")for(let U of c.children)n.push(U);else c.type==="page"&&(t=t.filter(U=>U!==c.pageID))}return t});const y=x();function u(t){let n={lastUpdated:Date.now(),tree:{root:{name:"Home",type:"folder",children:[]}}};const i=Object.hasOwn(t,"lastUpdated")&&typeof t.lastUpdated=="number"&&Object.hasOwn(t,"tree")&&typeof t.tree=="object";return i&&(n.lastUpdated=t.lastUpdated,n.tree=t.tree),{wasValid:i,sanitizedDirectory:n}}function f(){y.publishDoc(["directories","root"],{lastUpdated:e(a),tree:e(o)})}function F(t,n="New Folder"){if(!e(o)[t]||e(o)[t].type!=="folder")return;const i=crypto.randomUUID().slice(0,8);e(o)[i]={name:n,type:"folder",children:[]},e(o)[t].children.push(i)}function z(t,n){!e(o)[t]||e(o)[t].type!=="folder"||(e(o)[n]={name:"Untitled",type:"page",pageID:n},e(o)[t].children.push(n))}function S(t,n){!e(o)[t]||e(o)[t].type!=="folder"||(e(o)[t].children=e(o)[t].children.filter(i=>i!==n))}return y.subscribeToCollection(["directories"],(t,n)=>{if(t!=="root"){console.warn("Only root directory is currently supported");return}if(n===null){console.warn("Root directory does not exist! publishing new root"),f();return}let{wasValid:i,sanitizedDirectory:c}=u(n);if(!i){console.warn("Ignoring invalid root directory",n);return}c.lastUpdated<e(a)?f():c.lastUpdated>e(a)?(console.log("root directory updated"),p(g,!0),p(a,d(c.lastUpdated)),p(o,d(c.tree))):c.lastUpdated===e(a)&&console.log("directory synced with firebase",t)}),I(()=>{JSON.stringify(e(o)),R(()=>{if(e(g)){p(g,!1);return}p(a,d(Date.now())),f()})}),{get tree(){return e(o)},get currentPath(){return e(h)},set currentPath(t){p(h,d(t))},get currentFolder(){return e(D)},get addSubfolder(){return F},get addPageID(){return z},get removeChild(){return S},get orphanedFolders(){return e(r)},get orphanedPages(){return e(l)}}}const j=Symbol("directories"),A=()=>{const a=V();return m(j,a)},H=()=>O(j);export{H as a,A as b,N as g,v as s};
