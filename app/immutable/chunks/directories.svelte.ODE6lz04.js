import{p as s}from"./proxy.Csehax7D.js";import{s as j,g as k,a as u,b as t,c,u as R,d as h,e as v}from"./runtime.BZ2yvmcy.js";import{g as I}from"./firebase.svelte.-uLT7CDo.js";import{g as S}from"./pages.svelte.DoMi3FPE.js";function z(){let i=u(0),f=u(!0),m=s({name:"Home",type:"folder",children:[]}),o=u(s({root:m})),a=u(s(["root"])),b=h(()=>t(o)[t(a)[t(a).length-1]]),U=h(()=>{let e=Object.keys(t(o)).filter(n=>n!=="root"),r=["root"];for(;r.length>0;){let n=r.pop();if(!n||t(o)[n].type!=="folder")continue;let l=t(o)[n];for(let d of l.children)e=e.filter(P=>P!==d),r.push(d)}return e});const w=S();let D=h(()=>{let e=Object.keys(w),r=["root"];for(;r.length>0;){let n=r.pop();if(!n)continue;let l=t(o)[n];if(l.type==="folder")for(let d of l.children)r.push(d);else l.type==="page"&&(e=e.filter(d=>d!==l.pageID))}return e});const g=I();function C(e){let r={lastUpdated:Date.now(),tree:{root:{name:"Home",type:"folder",children:[]}}};const n=Object.hasOwn(e,"lastUpdated")&&typeof e.lastUpdated=="number"&&Object.hasOwn(e,"tree")&&typeof e.tree=="object";return n&&(r.lastUpdated=e.lastUpdated,r.tree=e.tree),{wasValid:n,sanitizedDirectory:r}}function p(){g.publishDoc(["directories","root"],{lastUpdated:t(i),tree:t(o)})}function x(e,r="New Folder"){if(!t(o)[e]||t(o)[e].type!=="folder")return;const n=crypto.randomUUID().slice(0,8);t(o)[n]={name:r,type:"folder",children:[]},t(o)[e].children.push(n)}function O(e,r){!t(o)[e]||t(o)[e].type!=="folder"||(t(o)[r]={name:"Untitled",type:"page",pageID:r},t(o)[e].children.push(r))}function F(e,r){!t(o)[e]||t(o)[e].type!=="folder"||(t(o)[e].children=t(o)[e].children.filter(n=>n!==r))}return g.subscribeToCollection(["directories"],(e,r)=>{if(e!=="root"){console.warn("Only root directory is currently supported");return}if(r===null){console.warn("Root directory does not exist! publishing new root"),p();return}let{wasValid:n,sanitizedDirectory:l}=C(r);if(!n){console.warn("Ignoring invalid root directory",r);return}l.lastUpdated<t(i)?p():l.lastUpdated>t(i)?(console.log("root directory updated"),c(f,!0),c(i,s(l.lastUpdated)),c(o,s(l.tree))):l.lastUpdated===t(i)&&console.log("directory synced with firebase",e)}),R(()=>{JSON.stringify(t(o)),v(()=>{if(t(f)){c(f,!1);return}c(i,s(Date.now())),p()})}),{get tree(){return t(o)},get currentPath(){return t(a)},set currentPath(e){c(a,s(e))},get currentFolder(){return t(b)},get addSubfolder(){return x},get addPageID(){return O},get removeChild(){return F},get orphanedFolders(){return t(U)},get orphanedPages(){return t(D)}}}const y=Symbol("directories"),V=()=>{const i=z();return j(y,i)},Y=()=>k(y);export{Y as g,V as s};
