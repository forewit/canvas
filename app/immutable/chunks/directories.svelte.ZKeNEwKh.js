import{p as d}from"./if.iF3oE4Wo.js";import{s as j,g as k,c as u,a as t,b as c,N as I,d as g,O as R}from"./runtime.DmHE6BeA.js";import{g as N}from"./themes.svelte.e9knPHAw.js";import{g as z}from"./pages.svelte.D6iAmqDa.js";function E(){let i=u(0),f=u(!0),m=d({name:"Home",type:"folder",children:[]}),o=u(d({root:m})),a=u(d(["root"])),b=g(()=>t(o)[t(a)[t(a).length-1]]),D=g(()=>{let e=Object.keys(t(o)).filter(n=>n!=="root"),r=["root"];for(;r.length>0;){let n=r.pop();if(!n||t(o)[n].type!=="folder")continue;let l=t(o)[n];for(let s of l.children)e=e.filter(S=>S!==s),r.push(s)}return e});const U=z();let w=g(()=>{let e=Object.keys(U),r=["root"];for(;r.length>0;){let n=r.pop();if(!n)continue;let l=t(o)[n];if(l.type==="folder")for(let s of l.children)r.push(s);else l.type==="page"&&(e=e.filter(s=>s!==l.pageID))}return e});const h=N();function C(e){let r={lastUpdated:Date.now(),tree:{root:{name:"Home",type:"folder",children:[]}}};const n=Object.hasOwn(e,"lastUpdated")&&typeof e.lastUpdated=="number"&&Object.hasOwn(e,"tree")&&typeof e.tree=="object";return n&&(r.lastUpdated=e.lastUpdated,r.tree=e.tree),{wasValid:n,sanitizedDirectory:r}}function p(){h.publishDoc(["directories","root"],{lastUpdated:t(i),tree:t(o)})}function O(e,r="New Folder"){if(!t(o)[e]||t(o)[e].type!=="folder")return;const n=crypto.randomUUID().slice(0,8);t(o)[n]={name:r,type:"folder",children:[]},t(o)[e].children.push(n)}function P(e,r){!t(o)[e]||t(o)[e].type!=="folder"||(t(o)[r]={name:"Untitled",type:"page",pageID:r},t(o)[e].children.push(r))}function x(e,r){!t(o)[e]||t(o)[e].type!=="folder"||(t(o)[e].children=t(o)[e].children.filter(n=>n!==r))}function v(e){}function F(e){}return h.subscribeToCollection(["directories"],(e,r)=>{if(e!=="root"){console.warn("Only root directory is currently supported");return}if(r===null){console.warn("Root directory does not exist! publishing new root"),p();return}let{wasValid:n,sanitizedDirectory:l}=C(r);if(!n){console.warn("Ignoring invalid root directory",r);return}l.lastUpdated<t(i)?p():l.lastUpdated>t(i)?(console.log("root directory updated"),c(f,!0),c(i,d(l.lastUpdated)),c(o,d(l.tree))):l.lastUpdated===t(i)&&console.log("directory synced with firebase",e)}),I(()=>{JSON.stringify(t(o)),R(()=>{if(t(f)){c(f,!1);return}c(i,d(Date.now())),p()})}),{get tree(){return t(o)},get currentPath(){return t(a)},set currentPath(e){c(a,d(e))},get currentFolder(){return t(b)},get addSubfolder(){return O},get removeSubfolder(){return F},get addPageID(){return P},get removePageID(){return v},get removeChild(){return x},get orphanedFolders(){return t(D)},get orphanedPages(){return t(w)}}}const y=Symbol("directories"),_=()=>{const i=E();return j(y,i)},J=()=>k(y);export{J as g,_ as s};
