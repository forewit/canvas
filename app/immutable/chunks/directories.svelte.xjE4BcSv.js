import{p as i}from"./proxy.DiDwt1nQ.js";import{s as S,g as j,e as c,f as e,i as f,u as k,j as h,k as v}from"./runtime.D_LhCXyF.js";import{g as R}from"./app.svelte.DnnDf6HZ.js";import{g as z}from"./pages.svelte.C5XGaOTi.js";function E(){let d=c(0),p=c(!0),D=i({name:"Home"}),n=c(i({root:D})),u=c(i(["root"])),o=h(()=>e(n)[e(u)[e(u).length-1]]),w=h(()=>{let t=Object.keys(e(n)).filter(l=>l!=="root"),r=["root"];for(;r.length>0;){let l=r.pop();if(!l)continue;let s=e(n)[l];if(s.subfolders)for(let a of s.subfolders)t=t.filter(b=>b!==a),r.push(a)}return t});const U=z();let P=h(()=>{let t=Object.keys(U),r=["root"];for(;r.length>0;){let l=r.pop();if(!l)continue;let s=e(n)[l];if(s.subfolders)for(let a of s.subfolders)r.push(a);if(s.pages)for(let a of s.pages)t=t.filter(b=>b!==a)}return t});const m=R();function x(t){let r={lastUpdated:Date.now(),folders:{root:{name:"Home"}}};const l=Object.hasOwn(t,"lastUpdated")&&typeof t.lastUpdated=="number"&&Object.hasOwn(t,"folders")&&typeof t.folders=="object";return l&&(r.lastUpdated=t.lastUpdated,r.folders=t.folders),{wasValid:l,sanitizedDirectory:r}}function g(){m.publishDoc(["directories","root"],{lastUpdated:e(d),folders:e(n)})}function O(t="New Folder"){const r=crypto.randomUUID().slice(0,8);e(o).subfolders||(e(o).subfolders=[]),e(n)[r]={name:t},e(o).subfolders.push(r)}function C(t){e(o).subfolders&&(e(o).subfolders=e(o).subfolders.filter(r=>r!==t),delete e(n)[t],e(o).subfolders.length===0&&delete e(o).subfolders)}function F(t){e(o).pages||(e(o).pages=[]),e(o).pages.push(t)}function I(t){e(o).pages&&(e(o).pages=e(o).pages.filter(r=>r!==t),e(o).pages.length===0&&delete e(o).pages)}return m.subscribeToCollection(["directories"],(t,r)=>{if(t!=="root"){console.warn("Only root directory is currently supported");return}if(r===null){console.warn("Root directory does not exist! publishing new root"),g();return}let{wasValid:l,sanitizedDirectory:s}=x(r);if(!l){console.warn("Ignoring invalid root directory",r);return}s.lastUpdated<e(d)?g():s.lastUpdated>e(d)?(console.log("root directory updated"),f(p,!0),f(d,i(s.lastUpdated)),f(n,i(s.folders))):s.lastUpdated===e(d)&&console.log("directory synced with firebase",t)}),k(()=>{JSON.stringify(e(n)),v(()=>{if(e(p)){f(p,!1);return}f(d,i(Date.now())),g()})}),{get folders(){return e(n)},get currentPath(){return e(u)},set currentPath(t){f(u,i(t))},get currentFolder(){return e(o)},get addSubfolder(){return O},get removeSubfolder(){return C},get addPageID(){return F},get removePageID(){return I},get orphanedFolders(){return e(w)},get orphanedPages(){return e(P)}}}const y=Symbol("directories"),_=()=>{const d=E();return S(y,d)},J=()=>j(y);export{J as g,_ as s};
