import{g as U,h as p,s as y}from"./runtime.DKEa1FBX.js";import{p as F}from"./proxy.DawioJ69.js";import{d,c as l,o as C,e as W,f as E,g as _,u as N,a as j}from"./firebase.client.CFiaGCcJ.js";import{u as i}from"./userState.svelte.BdjeXdIx.js";import{p as c}from"./pagesState.svelte.Meg3LB8x.js";const B=function(){if(!s.user)return console.warn("No user to fetch to user doc for."),()=>{};const t=d(l,"users",s.user.uid);return C(t,o=>{var e;if(!o.exists())console.log("Creating firestore user doc..."),E(t,{},{merge:!0});else{console.log("Fetched firestore userDoc"+(o.metadata.hasPendingWrites||o.metadata.fromCache?" (local):":":"),(e=s.user)==null?void 0:e.email);const n=o.data();s.userDoc=n}},o=>{console.error("Error while fetching firestore user doc",o)})},I=function(){if(!s.user)return console.warn("No user to fetch to page doc for."),()=>{};const t=W(l,"users",s.user.uid,"pages");return C(t,o=>{o.docChanges().forEach(e=>{const n=e.doc.data(),u=e.doc.id;e.type==="added"||e.type==="modified"?(console.log("Fetched firestore pageDoc"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),u.slice(0,4)),s.pageDocs[u]=n):e.type==="removed"&&(console.log("Firestore pageDoc removed"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),u.slice(0,4)),delete s.pageDocs[u])})})},O=(t,o=300)=>{let e;return(...n)=>{clearTimeout(e),e=setTimeout(()=>{t.apply(void 0,n)},o)}},$=1e3;let b={};const T=t=>{b[t]||(b[t]=O(()=>{delete b[t],Y(t)},$),b[t]())};async function Y(t){const o=s.user;if(!o){console.warn("No user to publish to firestore.");return}if(!c.pages[t]){console.warn("deleting page from firestore: ",t.slice(0,4)),await _(d(l,"users",o.uid,"pages",t)),s.isPublishing=!1;return}s.isPublishing=!0;const e=d(l,"users",o.uid,"pages",t);try{console.log(`Publishing page to firestore: ${t.slice(0,4)}...`),s.pageDocs[t]?await N(e,c.pages[t]):await E(e,c.pages[t])}catch(n){console.error("Error while publishing page to firestore",n)}finally{s.isPublishing=!1}}const v=O(q,$);async function q(){const t=s.user;if(!t){console.warn("No user to publish to firestore.");return}s.isPublishing=!0;const o=d(l,"users",t.uid);try{console.log("Publishing user State to firestore user doc..."),await N(o,{lastUpdated:i.lastUpdated,themeName:i.themeName,spellcheck:i.spellcheck})}catch(e){console.error("Error while publishing settings to firestore user doc",e)}finally{s.isPublishing=!1}}const z=function(){const t=c.subscribe(e=>{(!c.pages[e]||!s.pageDocs[e]||c.pages[e].lastUpdated>s.pageDocs[e].lastUpdated)&&(s.isPublishing=!0,T(e))}),o=s.subscribeToPageDocs(e=>{s.pageDocs[e]?s.pageDocs[e].lastUpdated===void 0?console.log(`ignoring undefined page: ${e.slice(0,4)}...`):c.pages[e]?s.pageDocs[e].lastUpdated===c.pages[e].lastUpdated?console.log(`page ${e.slice(0,4)} is synced.`):s.pageDocs[e].lastUpdated>c.pages[e].lastUpdated?(console.log(`page ${e.slice(0,4)} updated from firestore.`),c.pages[e]=s.pageDocs[e]):(s.isPublishing=!0,T(e)):(console.log(`page ${e.slice(0,4)} added from firestore.`),c.pages[e]=s.pageDocs[e]):c.pages[e]&&(console.log(`page ${e.slice(0,4)} removed.`),delete c.pages[e])});return()=>{t(),o()}},G=function(){const t=i.subscribe(()=>{i.lastUpdated>s.userDoc.lastUpdated&&(s.isPublishing=!0,v())}),o=s.subscribeToUserDoc(()=>{if(s.userDoc.lastUpdated===i.lastUpdated){console.log("User is synced.");return}else s.userDoc.lastUpdated>i.lastUpdated?(console.log("userState updated."),i.untrack(()=>{Object.assign(i,s.userDoc)})):(s.isPublishing=!0,v())});return()=>{t(),o()}};function H(){let t=y(null),o=y(!0),e=y(!1),n={},u=new Proxy({},{set(r,a,w){return w===r[a]||(r[a]=w,S(a)),!0},deleteProperty(r,a){return a in r?(delete r[a],S(a),!0):!1}}),g=[],f=[],h=()=>{},D=()=>{},m=()=>{},P=()=>{},A=j.onAuthStateChanged(r=>{U(t,F(r)),p(t)?(console.warn("Subscribing to user."),h=B(),D=I(),m=G(),P=z()):(console.warn("Unsubscribing from user."),h(),D(),m(),P())});const x=function(r){return g.push(r),()=>{g=g.filter(a=>a!==r)}},R=function(){g.forEach(r=>r())},k=function(r){return f.push(r),()=>{f=f.filter(a=>a!==r)}},S=function(r){f.forEach(a=>a(r))},L=function(){console.warn("Destroying FirebaseState."),A(),h(),D(),m(),P()};return{get user(){return p(t)},get isLoading(){return p(o)},get isPublishing(){return p(e)},set isPublishing(r){U(e,F(r))},get destroy(){return L},get userDoc(){return n},set userDoc(r){n=r,R(),U(o,!1)},get pageDocs(){return u},get subscribeToUserDoc(){return x},get subscribeToPageDocs(){return k}}}const s=H();export{s as f};
