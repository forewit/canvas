import{c as h,g as b,s as m}from"./runtime.CAZPmQP8.js";import{p as T}from"./proxy.DEkJLEVP.js";import{d as u,c as i,o as y,e as $,f as S,g as A,u as w,a as R}from"./firebase.client.CFiaGCcJ.js";import{p as r,u as c,o as D}from"./pagesState.svelte.C_0Kqgt5.js";const k=function(){if(!s.user)return console.warn("No user to fetch to user doc for."),()=>{};const t=u(i,"users",s.user.uid);return y(t,o=>{var e;if(!o.exists())console.log("Creating firestore user doc..."),S(t,{},{merge:!0});else{console.log("Fetched firestore userDoc"+(o.metadata.hasPendingWrites||o.metadata.fromCache?" (local):":":"),(e=s.user)==null?void 0:e.email);const a=o.data();Object.assign(s.userDoc,a)}},o=>{console.error("Error while fetching firestore user doc",o)})},x=function(){if(!s.user)return console.warn("No user to fetch to page doc for."),()=>{};const t=$(i,"users",s.user.uid,"pages");return y(t,o=>{o.docChanges().forEach(e=>{const a=e.doc.data(),n=e.doc.id;e.type==="added"||e.type==="modified"?(console.log("Fetched firestore pageDoc"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),n.slice(0,4)),s.pageDocs.get()[n]=a):e.type==="removed"&&(console.log("Firestore pageDoc removed"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),n.slice(0,4)),delete s.pageDocs.get()[n])})})},F=(t,o=300)=>{let e;return(...a)=>{clearTimeout(e),e=setTimeout(()=>{t.apply(void 0,a)},o)}},C=1e3;let l={};const U=t=>{l[t]||(l[t]=F(()=>{delete l[t],L(t)},C),l[t]())};async function L(t){const o=s.user;if(!o){console.warn("No user to publish to firestore.");return}if(!r.get()[t]){console.warn("deleting page from firestore: ",t.slice(0,4)),await A(u(i,"users",o.uid,"pages",t)),s.isPublishing=!1;return}s.isPublishing=!0;const e=u(i,"users",o.uid,"pages",t);try{console.log(`Publishing page to firestore: ${t.slice(0,4)}...`);const a={lastUpdated:r.get()[t].lastUpdated,title:r.get()[t].title,content:r.get()[t].content};s.pageDocs.get()[t]?await w(e,a):await S(e,a)}catch(a){console.error("Error while publishing page to firestore",a)}finally{s.isPublishing=!1}}const P=F(O,C);async function O(){const t=s.user;if(!t){console.warn("No user to publish to firestore.");return}s.isPublishing=!0;const o=u(i,"users",t.uid);try{console.log("Publishing user State to firestore user doc..."),await w(o,{lastUpdated:c.get().lastUpdated,themeName:c.get().themeName,spellcheck:c.get().spellcheck,root:c.get().root})}catch(e){console.error("Error while publishing settings to firestore user doc",e)}finally{s.isPublishing=!1}}const W=function(){const t=c.subscribe(()=>{c.get().lastUpdated>s.userDoc.get().lastUpdated&&(s.isPublishing=!0,P())}),o=s.userDoc.subscribe(()=>{if(s.userDoc.get().lastUpdated===c.get().lastUpdated){console.log("User is synced.");return}else s.userDoc.get().lastUpdated>c.get().lastUpdated?(console.log("userState updated."),c.untrack(()=>{Object.assign(c,s.userDoc)})):(s.isPublishing=!0,P())});return()=>{t(),o()}},_=function(){const t=r.subscribe(e=>{(!r.get()[e]||!s.pageDocs.get()[e]||r.get()[e].lastUpdated>s.pageDocs.get()[e].lastUpdated)&&(s.isPublishing=!0,U(e))}),o=s.pageDocs.subscribe(e=>{s.pageDocs.get()[e]?s.pageDocs.get()[e].lastUpdated===void 0?console.log(`ignoring undefined page: ${e.slice(0,4)}...`):r.get()[e]?s.pageDocs.get()[e].lastUpdated===r.get()[e].lastUpdated?console.log(`page ${e.slice(0,4)} is synced.`):s.pageDocs.get()[e].lastUpdated>r.get()[e].lastUpdated?(console.log(`page ${e.slice(0,4)} updated from firestore.`),r.get()[e],s.pageDocs.get()[e]):(s.isPublishing=!0,U(e)):(console.log(`page ${e.slice(0,4)} added from firestore.`),r.get()[e]=s.pageDocs.get()[e]):r.get()[e]&&(console.log(`page ${e.slice(0,4)} removed.`),delete r.get()[e])});return()=>{t(),o()}};function j(){let t=m(null),o=m(!0),e=!1,a=D({}),n=D({}),g=()=>{},f=()=>{},d=()=>{},p=()=>{};const v=R.onAuthStateChanged(N=>{h(t,T(N)),h(o,!1),b(t)?(console.warn("Subscribing to user."),g=k(),f=x(),d=W(),p=_()):(console.warn("Unsubscribing from user."),g(),f(),d(),p())}),E=function(){console.warn("Destroying FirebaseState."),v(),g(),f(),d(),p()};return{userDoc:a,isPublishing:e,get pageDocs(){return n},get user(){return b(t)},get isLoading(){return b(o)},get destroy(){return E}}}const s=j();export{s as f};
