import{p as P}from"./proxy.DEl-fzJA.js";import{y as m,A as g,x as D}from"./runtime.D4DqS6tz.js";import{d as f,c as u,o as w,e as T,f as F,g as $,u as C,a as x}from"./firebase.client.bXpNPLp1.js";import{p as r,u as c,o as U}from"./pagesState.svelte.BgdIMNhs.js";const R=function(){if(!t.user)return console.warn("No user to fetch to user doc for."),()=>{};const s=f(u,"users",t.user.uid);return w(s,o=>{var e;if(!o.exists())console.log("Creating firestore user doc..."),F(s,{},{merge:!0});else{console.log("Fetched firestore userDoc"+(o.metadata.hasPendingWrites||o.metadata.fromCache?" (local):":":"),(e=t.user)==null?void 0:e.email);const a=o.data();t.userDoc.set(a)}},o=>{console.error("Error while fetching firestore user doc",o)})},k=function(){if(!t.user)return console.warn("No user to fetch to page doc for."),()=>{};const s=T(u,"users",t.user.uid,"pages");return w(s,o=>{o.docChanges().forEach(e=>{const a=e.doc.data(),n=e.doc.id;e.type==="added"||e.type==="modified"?(console.log("Fetched firestore pageDoc"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),n.slice(0,4)),t.pageDocs.get()[n]=a):e.type==="removed"&&(console.log("Firestore pageDoc removed"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),n.slice(0,4)),delete t.pageDocs.get()[n])})})},v=(s,o=300)=>{let e;return(...a)=>{clearTimeout(e),e=setTimeout(()=>{s.apply(void 0,a)},o)}},E=1e3;let l={};const y=s=>{if(l[s]){l[s]();return}l[s]=v(()=>{delete l[s],L(s)},E),l[s]()};async function L(s){const o=t.user;if(!o){console.warn("No user to publish to firestore.");return}if(!r.get()[s]){console.warn("deleting page from firestore: ",s.slice(0,4)),await $(f(u,"users",o.uid,"pages",s)),t.isPublishing=!1;return}t.isPublishing=!0;const e=f(u,"users",o.uid,"pages",s);try{console.log(`Publishing page to firestore: ${s.slice(0,4)}...`);const a={lastUpdated:r.get()[s].lastUpdated,title:r.get()[s].title,content:r.get()[s].content};t.pageDocs.get()[s]?await C(e,a):await F(e,a)}catch(a){console.error("Error while publishing page to firestore",a)}finally{t.isPublishing=!1}}const S=v(W,E);async function W(){const s=t.user;if(!s){console.warn("No user to publish to firestore.");return}t.isPublishing=!0;const o=f(u,"users",s.uid);try{console.log("Publishing user State to firestore user doc..."),await C(o,{lastUpdated:c.get().lastUpdated,themeName:c.get().themeName,spellcheck:c.get().spellcheck,root:c.get().root})}catch(e){console.error("Error while publishing settings to firestore user doc",e)}finally{t.isPublishing=!1}}const _=function(){const s=c.subscribe(()=>{c.get().lastUpdated>t.userDoc.get().lastUpdated&&(t.isPublishing=!0,S())}),o=t.userDoc.subscribe(()=>{if(t.userDoc.get().lastUpdated===c.get().lastUpdated){console.log("User is synced.");return}else t.userDoc.get().lastUpdated>c.get().lastUpdated?(console.log("userState updated."),c.untrack(()=>{c.set(t.userDoc.get())})):(t.isPublishing=!0,S())});return()=>{s(),o()}},B=function(){const s=r.subscribe(e=>{(!r.get()[e]||!t.pageDocs.get()[e]||r.get()[e].lastUpdated>t.pageDocs.get()[e].lastUpdated)&&(t.isPublishing=!0,y(e))}),o=t.pageDocs.subscribe(e=>{t.pageDocs.get()[e]?t.pageDocs.get()[e].lastUpdated===void 0?console.log(`ignoring undefined page: ${e.slice(0,4)}...`):r.get()[e]?t.pageDocs.get()[e].lastUpdated===r.get()[e].lastUpdated?console.log(`page ${e.slice(0,4)} is synced.`):t.pageDocs.get()[e].lastUpdated>r.get()[e].lastUpdated?(console.log(`page ${e.slice(0,4)} updated from firestore.`),r.get()[e],t.pageDocs.get()[e]):(t.isPublishing=!0,y(e)):(console.log(`page ${e.slice(0,4)} added from firestore.`),r.get()[e]=t.pageDocs.get()[e]):r.get()[e]&&(console.log(`page ${e.slice(0,4)} removed.`),delete r.get()[e])});return()=>{s(),o()}};function I(){let s=D(null),o=D(!0),e=D(!1),a=U({}),n=U({}),d=()=>{},p=()=>{},b=()=>{},h=()=>{};const N=x.onAuthStateChanged(i=>{m(s,P(i)),m(o,!1),g(s)?(console.warn("Subscribing to user."),d=R(),p=k(),b=_(),h=B()):(console.warn("Unsubscribing from user."),d(),p(),b(),h())}),A=function(){console.warn("Destroying FirebaseState."),N(),d(),p(),b(),h()};return{get isPublishing(){return g(e)},set isPublishing(i){m(e,P(i))},get userDoc(){return a},set userDoc(i){a=U(i)},get pageDocs(){return n},get user(){return g(s)},get isLoading(){return g(o)},get destroy(){return A}}}const t=I();export{t as f};
