import{c as P,g as d,s as y}from"./runtime.DQzYxgOy.js";import{p as T}from"./proxy.BSfg9Vi9.js";import{d as p,c as l,o as E,e as W,f as N,g as _,u as O,a as j}from"./firebase.client.CFiaGCcJ.js";import{p as c,u as i}from"./pagesState.svelte.l_q5DSsV.js";const B=function(){if(!s.user)return console.warn("No user to fetch to user doc for."),()=>{};const t=p(l,"users",s.user.uid);return E(t,o=>{var e;if(!o.exists())console.log("Creating firestore user doc..."),N(t,{},{merge:!0});else{console.log("Fetched firestore userDoc"+(o.metadata.hasPendingWrites||o.metadata.fromCache?" (local):":":"),(e=s.user)==null?void 0:e.email);const n=o.data();s.userDoc=n}},o=>{console.error("Error while fetching firestore user doc",o)})},I=function(){if(!s.user)return console.warn("No user to fetch to page doc for."),()=>{};const t=W(l,"users",s.user.uid,"pages");return E(t,o=>{o.docChanges().forEach(e=>{const n=e.doc.data(),u=e.doc.id;e.type==="added"||e.type==="modified"?(console.log("Fetched firestore pageDoc"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),u.slice(0,4)),s.pageDocs[u]=n):e.type==="removed"&&(console.log("Firestore pageDoc removed"+(e.doc.metadata.hasPendingWrites||e.doc.metadata.fromCache?" (local):":":"),u.slice(0,4)),delete s.pageDocs[u])})})},$=(t,o=300)=>{let e;return(...n)=>{clearTimeout(e),e=setTimeout(()=>{t.apply(void 0,n)},o)}},A=1e3;let b={};const v=t=>{b[t]||(b[t]=$(()=>{delete b[t],Y(t)},A),b[t]())};async function Y(t){const o=s.user;if(!o){console.warn("No user to publish to firestore.");return}if(!c.get()[t]){console.warn("deleting page from firestore: ",t.slice(0,4)),await _(p(l,"users",o.uid,"pages",t)),s.isPublishing=!1;return}s.isPublishing=!0;const e=p(l,"users",o.uid,"pages",t);try{console.log(`Publishing page to firestore: ${t.slice(0,4)}...`);const n={lastUpdated:c.get()[t].lastUpdated,title:c.get()[t].title,content:c.get()[t].content};s.pageDocs[t]?await O(e,n):await N(e,n)}catch(n){console.error("Error while publishing page to firestore",n)}finally{s.isPublishing=!1}}const C=$(q,A);async function q(){const t=s.user;if(!t){console.warn("No user to publish to firestore.");return}s.isPublishing=!0;const o=p(l,"users",t.uid);try{console.log("Publishing user State to firestore user doc..."),await O(o,{lastUpdated:i.get().lastUpdated,themeName:i.get().themeName,spellcheck:i.get().spellcheck,root:i.get().root})}catch(e){console.error("Error while publishing settings to firestore user doc",e)}finally{s.isPublishing=!1}}const z=function(){const t=i.subscribe(()=>{i.get().lastUpdated>s.userDoc.lastUpdated&&(s.isPublishing=!0,C())}),o=s.subscribeToUserDoc(()=>{if(s.userDoc.lastUpdated===i.get().lastUpdated){console.log("User is synced.");return}else s.userDoc.lastUpdated>i.get().lastUpdated?(console.log("userState updated."),i.untrack(()=>{Object.assign(i,s.userDoc)})):(s.isPublishing=!0,C())});return()=>{t(),o()}},G=function(){const t=c.subscribe(e=>{(!c.get()[e]||!s.pageDocs[e]||c.get()[e].lastUpdated>s.pageDocs[e].lastUpdated)&&(s.isPublishing=!0,v(e))}),o=s.subscribeToPageDocs(e=>{s.pageDocs[e]?s.pageDocs[e].lastUpdated===void 0?console.log(`ignoring undefined page: ${e.slice(0,4)}...`):c.get()[e]?s.pageDocs[e].lastUpdated===c.get()[e].lastUpdated?console.log(`page ${e.slice(0,4)} is synced.`):s.pageDocs[e].lastUpdated>c.get()[e].lastUpdated?(console.log(`page ${e.slice(0,4)} updated from firestore.`),c.get()[e],s.pageDocs[e]):(s.isPublishing=!0,v(e)):(console.log(`page ${e.slice(0,4)} added from firestore.`),c.get()[e]=s.pageDocs[e]):c.get()[e]&&(console.log(`page ${e.slice(0,4)} removed.`),delete c.get()[e])});return()=>{t(),o()}};function H(){let t=y(null),o=y(!0),e=y(!1),n={},u=new Proxy({},{set(r,a,F){return F===r[a]||(r[a]=F,w(a)),!0},deleteProperty(r,a){return a in r?(delete r[a],w(a),!0):!1}}),g=[],f=[],h=()=>{},D=()=>{},m=()=>{},U=()=>{},x=j.onAuthStateChanged(r=>{P(t,T(r));const a=S(()=>{P(o,!1),a()});d(t)?(console.warn("Subscribing to user."),h=B(),D=I(),m=z(),U=G()):(console.warn("Unsubscribing from user."),h(),D(),m(),U())});const S=function(r){return g.push(r),()=>{g=g.filter(a=>a!==r)}},R=function(){g.forEach(r=>r())},k=function(r){return f.push(r),()=>{f=f.filter(a=>a!==r)}},w=function(r){f.forEach(a=>a(r))},L=function(){console.warn("Destroying FirebaseState."),x(),h(),D(),m(),U()};return{get user(){return d(t)},get isLoading(){return d(o)},get isPublishing(){return d(e)},set isPublishing(r){P(e,T(r))},get destroy(){return L},get userDoc(){return n},set userDoc(r){n=r,R()},get pageDocs(){return u},get subscribeToUserDoc(){return S},get subscribeToPageDocs(){return k}}}const s=H();export{s as f};
