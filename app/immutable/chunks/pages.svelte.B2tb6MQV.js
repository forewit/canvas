import{p as a}from"./proxy.V3ps-ERZ.js";import{R as D,X as x,$ as m,a0 as P,v as c,w as d,t as g}from"./runtime.CrOvq7Gc.js";import{g as U}from"./firebase.svelte.B5El6fZa.js";import{w as v}from"./entry.Bpl0Gw6I.js";function y(s,n){return{subscribe:v(s(),p=>{let i=!1;const b=D(()=>{x(()=>{const e=s();i&&p(e)})});return i=!0,b}).subscribe}}function C(){let s=g("Canvas"),n=g(!0),o=0;const p=U();function i(){p.publishDataToUserDoc({lastUpdated:o,themeName:c(s),spellcheck:c(n)})}function b(t){t.themeName!==void 0&&d(s,a(t.themeName)),t.spellcheck!==void 0&&d(n,a(t.spellcheck))}return y(()=>p.userDoc).subscribe(t=>{p.isLoading||(t.lastUpdated===void 0||t.lastUpdated<o?i():t.lastUpdated>o?b(t):t.lastUpdated===o&&console.log("app in sync with user doc"))}),{get themeName(){return c(s)},set themeName(t){d(s,a(t)),o=Date.now(),i()},get spellcheck(){return c(n)},set spellcheck(t){d(n,a(t)),o=Date.now(),i()}}}const h=Symbol("app"),z=()=>{const s=C();return m(h,s)},F=()=>P(h);function N(){let s=a({});const n=U();n.subscribeToPages(o);function o(e){let t=s[e],r=n.pagesCollection[e];if(!r){t&&delete s[e],console.log("deleted page",e.slice(0,4));return}let{wasValid:f,sanitizedPage:l}=p(r);if(!f){console.warn("Sanitized invalid page",r,l),n.publishDataToPageDoc(e,l);return}if(!t){s[e]=i(e,l),console.log("added page",e.slice(0,4));return}l.lastUpdated<t.lastUpdated?n.publishDataToPageDoc(e,t):l.lastUpdated>t.lastUpdated?s[e]=i(e,l):l.lastUpdated===t.lastUpdated&&console.log("page synced with firebase",e.slice(0,4))}function p(e){return{wasValid:e.lastUpdated!==void 0&&e.title!==void 0&&e.content!==void 0,sanitizedPage:{title:e.title===void 0?"New Page":e.title,content:e.content===void 0?"":e.content,lastUpdated:e.lastUpdated===void 0?Date.now():e.lastUpdated}}}const i=function(e,t){let r=g(a(t.lastUpdated)),f=g(a(t.title)),l=g(a(t.content));return{get lastUpdated(){return c(r)},set lastUpdated(u){d(r,a(u))},get title(){return c(f)},set title(u){u!==c(f)&&(d(f,a(u)),d(r,a(Date.now())),o(e))},get content(){return c(l)},set content(u){u!==c(l)&&(d(l,a(u)),d(r,a(Date.now())),o(e))}}};return new Proxy(s,{set:(e,t,r)=>(e[t]=i(t,r),e[t].lastUpdated=Date.now(),n.publishDataToPageDoc(t,r),!0),deleteProperty:(e,t)=>(delete e[t],n.publishDataToPageDoc(t),!0)})}const w=Symbol("pages"),_=()=>{const s=N();return m(w,s)},E=()=>P(w);export{E as a,_ as b,F as g,z as s};
