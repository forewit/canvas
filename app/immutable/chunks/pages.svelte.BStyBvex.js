import{p as n}from"./proxy.CDy8FXUy.js";import{s as b,g as U,e as u,f as c,i as d}from"./runtime.fZwd0kuQ.js";import{g as D}from"./app.svelte.DRcnNZ_c.js";function w(){let o=n({});const l=D();l.subscribeToPagesCollection(f);function f(e,a){let t=o[e],r=l.pagesCollection[e];if(a==="removed"){t&&delete o[e],console.log("deleted page",e.slice(0,4));return}if(!r){l.publishDataToPageDoc(e,t);return}let{wasValid:i,sanitizedPage:s}=P(r);if(!i){console.warn("Sanitized invalid page",r,s),l.publishDataToPageDoc(e,s);return}if(!t){o[e]=g(e,s),console.log("added page",e.slice(0,4));return}s.lastUpdated<t.lastUpdated?l.publishDataToPageDoc(e,t):s.lastUpdated>t.lastUpdated?o[e]=g(e,s):s.lastUpdated===t.lastUpdated&&console.log("page synced with firebase",e.slice(0,4))}function P(e){let a=!0,t={title:"New Page",content:"",lastUpdated:Date.now()};return Object.hasOwn(e,"lastUpdated")&&typeof e.lastUpdated=="number"?t.lastUpdated=e.lastUpdated:a=!1,Object.hasOwn(e,"title")&&typeof e.title=="string"?t.title=e.title:a=!1,Object.hasOwn(e,"content")&&typeof e.content=="string"?t.content=e.content:a=!1,{wasValid:a,sanitizedPage:t}}const g=function(e,a){let t=u(n(a.lastUpdated)),r=u(n(a.title)),i=u(n(a.content));return{get lastUpdated(){return c(t)},set lastUpdated(s){d(t,n(s))},get title(){return c(r)},set title(s){s!==c(r)&&(d(r,n(s)),d(t,n(Date.now())),f(e,"modified"))},get content(){return c(i)},set content(s){s!==c(i)&&(d(i,n(s)),d(t,n(Date.now())),f(e,"modified"))}}};return new Proxy(o,{set:(e,a,t)=>(e[a]=g(a,t),l.publishDataToPageDoc(a,t),!0),deleteProperty:(e,a)=>(delete e[a],l.publishDataToPageDoc(a),!0)})}const p=Symbol("pages"),C=()=>{const o=w();return b(p,o)},O=()=>U(p);export{O as g,C as s};
