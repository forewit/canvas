import{p as o}from"./proxy.CIU44urm.js";import{s as P,g as U,a as p,b as i,c as g}from"./runtime.DGpmsJ_j.js";import{g as w}from"./firebase.svelte.BwEUVfvs.js";function y(){let n=o({});const r=w();r.subscribeToCollection(["pages"],f);function f(t,e){let s=n[t];if(!e){s&&delete n[t],console.log("deleted page",t.slice(0,4));return}let{wasValid:c,sanitizedPage:a}=b(e);if(!c){console.warn("Ignoring invalid page",e);return}if(!s){n[t]=d(t,a),console.log("added page",t);return}a.lastUpdated<s.lastUpdated?r.publishDoc(["pages",t],s):a.lastUpdated>s.lastUpdated?n[t]=d(t,a):a.lastUpdated===s.lastUpdated&&console.log("page synced with firebase",t)}function b(t){let e={title:"New Page",content:"",lastUpdated:Date.now()};const s=Object.hasOwn(t,"lastUpdated")&&typeof t.lastUpdated=="number"&&Object.hasOwn(t,"title")&&typeof t.title=="string"&&Object.hasOwn(t,"content")&&typeof t.content=="string";return s&&(e.lastUpdated=t.lastUpdated,e.title=t.title,e.content=t.content),{wasValid:s,sanitizedPage:e}}const d=function(t,e){let s=p(o(e.lastUpdated)),c=p(o(e.title)),a=p(o(e.content));return{get lastUpdated(){return i(s)},set lastUpdated(l){g(s,o(l))},get title(){return i(c)},set title(l){l!==i(c)&&(g(c,o(l)),g(s,o(Date.now())),r.publishDoc(["pages",t],n[t]))},get content(){return i(a)},set content(l){l!==i(a)&&(g(a,o(l)),g(s,o(Date.now())),r.publishDoc(["pages",t],n[t]))}}};return new Proxy(n,{set:(t,e,s)=>(t[e]=d(e,s),r.publishDoc(["pages",e],s),!0),deleteProperty:(t,e)=>(delete t[e],r.publishDoc(["pages",e],null),!0)})}const u=Symbol("pages"),C=()=>{const n=y();return P(u,n)},O=()=>U(u);export{O as g,C as s};
