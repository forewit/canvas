import{p as n}from"./proxy.V3ps-ERZ.js";import{R as w,X as D,$ as b,a0 as P,v as c,w as d,t as g}from"./runtime.CrOvq7Gc.js";import{g as m}from"./firebase.svelte.B5El6fZa.js";import{w as x}from"./entry.Bf8slej5.js";function y(a,o){return{subscribe:x(a(),i=>{let u=!1;const e=w(()=>{D(()=>{const s=a();u&&i(s)})});return u=!0,e}).subscribe}}function v(){let a=g("Canvas"),o=g(!0),l=0;const i=m();function u(){i.publishDataToUserDoc({lastUpdated:l,themeName:c(a),spellcheck:c(o)})}function e(t){t.themeName!==void 0&&d(a,n(t.themeName)),t.spellcheck!==void 0&&d(o,n(t.spellcheck))}return y(()=>i.userDoc).subscribe(t=>{i.isLoading||(t.lastUpdated===void 0||t.lastUpdated<l?u():t.lastUpdated>l?e(t):t.lastUpdated===l&&console.log("app in sync with user doc"))}),{get themeName(){return c(a)},set themeName(t){d(a,n(t)),l=Date.now(),u()},get spellcheck(){return c(o)},set spellcheck(t){d(o,n(t)),l=Date.now(),u()}}}const h=Symbol("app"),A=()=>{const a=v();return b(h,a)},z=()=>P(h);function C(){let a=n({});const o=m();o.subscribeToPages(e=>{let s=a[e],t=o.pagesCollection[e];if(!t){s&&delete a[e],console.log("deleted page",e.slice(0,4));return}let{wasValid:f,sanitizedPage:r}=l(t);if(!f){console.warn("Sanitized invalid page",t,r),o.publishDataToPageDoc(e,r);return}if(!s){a[e]=i(e,r),console.log("added page",e.slice(0,4));return}r.lastUpdated<s.lastUpdated?o.publishDataToPageDoc(e,s):r.lastUpdated>s.lastUpdated?a[e]=i(e,r):r.lastUpdated===s.lastUpdated&&console.log("page synced with firebase",e.slice(0,4))});function l(e){return{wasValid:e.lastUpdated!==void 0&&e.title!==void 0&&e.content!==void 0,sanitizedPage:{title:e.title===void 0?"New Page":e.title,content:e.content===void 0?"":e.content,lastUpdated:e.lastUpdated===void 0?Date.now():e.lastUpdated}}}const i=function(e,s){let t=g(n(s.lastUpdated)),f=g(n(s.title)),r=g(n(s.content));return{get lastUpdated(){return c(t)},set lastUpdated(p){d(t,n(p))},get title(){return c(f)},set title(p){p!==c(f)&&(d(f,n(p)),d(t,n(Date.now())),console.log("hi"),o.notifyPageSubscribers(e))},get content(){return c(r)},set content(p){p!==c(r)&&(d(r,n(p)),d(t,n(Date.now())),o.notifyPageSubscribers(e))}}};return new Proxy(a,{set:(e,s,t)=>(e[s]=i(s,t),e[s].lastUpdated=Date.now(),o.publishDataToPageDoc(s,t),!0),deleteProperty:(e,s)=>(delete e[s],o.publishDataToPageDoc(s),!0)})}const U=Symbol("pages"),F=()=>{const a=C();return b(U,a)},_=()=>P(U);export{_ as a,F as b,z as g,A as s};
